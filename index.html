<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agendamento Avaliação Física - Vila Império</title>

<style>
body{margin:0;font-family:'Segoe UI',Roboto,Arial;background:#f1f3f4;color:#202124}
button{cursor:pointer;padding:8px 14px;margin:4px;border:none;border-radius:8px;background:#e8eaed;transition:0.2s}
button:hover{background:#dadce0}
.header-login{text-align:center;padding:40px;background:white;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.login-container{display:flex;justify-content:center;gap:40px;margin-top:60px}
.login-box{width:220px;height:220px;border-radius:16px;background:white;display:flex;justify-content:center;align-items:center;font-size:20px;font-weight:500;box-shadow:0 1px 4px rgba(0,0,0,0.15);transition:0.2s}
.login-box:hover{background:#1a73e8;color:white;transform:translateY(-4px)}
.layout{display:flex;height:100vh}
.sidebar{width:260px;background:white;border-right:1px solid #dadce0;display:flex;flex-direction:column}
.sidebar-header{text-align:center;padding:25px;border-bottom:1px solid #dadce0}
.sidebar button{background:none;text-align:left;padding:14px}
.sidebar button:hover{background:#f1f3f4}
.content{flex:1;padding:30px;overflow:auto}
.card{background:white;padding:16px;margin-bottom:14px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.15)}
.cal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.dia{padding:12px;text-align:center;border-radius:10px;background:white;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
.dia.inativo{background:#f1f3f4;opacity:0.5}
.dia.bloqueado{background:#ea4335;color:white}
.grid-horarios{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:20px}
.horario{padding:10px;border-radius:8px;background:white;border:1px solid #dadce0}
.horario.ocupado{background:#e0e0e0}
.horario.bloqueado{background:#ea4335;color:white}
.status{padding:4px 10px;border-radius:20px;font-size:12px}
.pendente{background:#9aa0a6;color:white}
.mensagem{background:#fbbc04}
.confirmado{background:#1a73e8;color:white}
.realizado{background:#34a853;color:white}
.faltou{background:#ea4335;color:white}
</style>
</head>
<body>

<div id="loginScreen">
<div class="header-login">
<h2>AGENDAMENTO AVALIAÇÃO FÍSICA</h2>
</div>
<div class="login-container">
<div class="login-box" onclick="login('admin')">ADMIN</div>
<div class="login-box" onclick="login('recepcao')">RECEPÇÃO</div>
<div class="login-box" onclick="login('professor')">PROFESSOR</div>
</div>
</div>

<div id="app" class="layout" style="display:none;">
<div class="sidebar">
<div class="sidebar-header">
<h4 id="usuario"></h4>
</div>
<div id="menu"></div>
<button onclick="logout()">Sair</button>
</div>
<div class="content">
<div id="main"></div>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCYvSYG54zyCV70c2fVJxlvCdlwg10BsTQ",
  authDomain: "agendamento-vila-imperio.firebaseapp.com",
  projectId: "agendamento-vila-imperio",
  storageBucket: "agendamento-vila-imperio.firebasestorage.app",
  messagingSenderId: "749813711068",
  appId: "1:749813711068:web:2330d2bfd5879bff44b419"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let agendamentos=[];
let bloqueios=[];
let state={tipo:null,nome:null,mes:new Date().getMonth(),ano:new Date().getFullYear(),modo:null,dataAtual:null};

const horarios=["06:30","06:50","07:50","08:10","08:30","08:50","09:10","09:30","16:00","16:20","16:40","17:00","17:20","17:40","18:00","18:20","18:40","19:20","19:40","21:00","21:20"];

/* LISTENERS REALTIME */
onSnapshot(collection(db,"agendamentos"),snap=>{
agendamentos=snap.docs.map(d=>({...d.data(),docId:d.id}));
if(state.dataAtual) abrirDia(state.dataAtual);
else renderCalendario();
});

onSnapshot(collection(db,"bloqueios"),snap=>{
bloqueios=snap.docs.map(d=>({...d.data(),docId:d.id}));
renderCalendario();
});

/* LOGIN */
window.login=function(tipo){
state.tipo=tipo;
state.nome=tipo.toUpperCase();
document.getElementById("loginScreen").style.display="none";
document.getElementById("app").style.display="flex";
document.getElementById("usuario").innerText=state.nome;
renderMenu();
renderCalendario();
}
window.logout=function(){location.reload()}

/* MENU */
function renderMenu(){
let m=document.getElementById("menu");
m.innerHTML="";
m.innerHTML+=`<button onclick="renderCalendario()">Calendário</button>`;
if(state.tipo!=="professor"){
m.innerHTML+=`<button onclick="state.modo='agendar';renderCalendario()">Agendar</button>`;
m.innerHTML+=`<button onclick="state.modo='bloqDia';renderCalendario()">Bloquear Dia</button>`;
m.innerHTML+=`<button onclick="state.modo='bloqHora';renderCalendario()">Bloquear Horário</button>`;
}
}

/* CALENDÁRIO */
function renderCalendario(){
let main=document.getElementById("main");
main.innerHTML=`<div class="cal-header">
<button onclick="mesAnt()">◀</button>
<h2>${nomeMes(state.mes)} ${state.ano}</h2>
<button onclick="mesProx()">▶</button>
</div>
<div class="cal-grid" id="grid"></div>`;
let grid=document.getElementById("grid");
let primeiro=new Date(state.ano,state.mes,1).getDay();
let total=new Date(state.ano,state.mes+1,0).getDate();
for(let i=0;i<primeiro;i++)grid.appendChild(document.createElement("div"));
for(let d=1;d<=total;d++){
let data=formatar(state.ano,state.mes,d);
let div=document.createElement("div");
div.className="dia";
div.innerText=d;
let bloqueio=bloqueios.find(b=>b.data===data && b.tipo==="dia");
if(bloqueio) div.classList.add("bloqueado");
div.onclick=()=>clicarDia(data);
grid.appendChild(div);
}
}

/* DIA */
async function clicarDia(data){
if(state.modo==="bloqDia"){
let existe=bloqueios.find(b=>b.data===data && b.tipo==="dia");
if(!existe) await addDoc(collection(db,"bloqueios"),{data,tipo:"dia"});
return;
}
abrirDia(data);
}

function abrirDia(data){
state.dataAtual=data;
let main=document.getElementById("main");
main.innerHTML=`<h2>${data}</h2><button onclick="renderCalendario()">Voltar</button>
<div class="grid-horarios" id="horarios"></div><div id="lista"></div>`;
let grid=document.getElementById("horarios");
horarios.forEach(h=>{
let btn=document.createElement("button");
btn.className="horario";
btn.innerText=h;
let ocupado=agendamentos.find(a=>a.data===data && a.horario===h);
if(ocupado){btn.classList.add("ocupado");btn.disabled=true;}
else if(state.modo==="agendar"){
btn.onclick=async()=>{await addDoc(collection(db,"agendamentos"),{data,horario:h,nome:"Aluno",status:"pendente"});}
}
grid.appendChild(btn);
});
mostrarLista(data);
}

function mostrarLista(data){
let lista=agendamentos.filter(a=>a.data===data);
let div=document.getElementById("lista");
div.innerHTML="<h3>Agendamentos</h3>";
lista.forEach(a=>{
div.innerHTML+=`<div class="card">
<b>${a.horario}</b> - ${a.nome}
<span class="status ${a.status}">${a.status}</span>
<button onclick="cancelar('${a.docId}')">Cancelar</button>
</div>`;
});
}

window.cancelar=async function(id){
await deleteDoc(doc(db,"agendamentos",id));
}

/* UTIL */
window.mesAnt=function(){state.mes--;if(state.mes<0){state.mes=11;state.ano--;}renderCalendario()}
window.mesProx=function(){state.mes++;if(state.mes>11){state.mes=0;state.ano++;}renderCalendario()}
function formatar(a,m,d){return a+"-"+String(m+1).padStart(2,"0")+"-"+String(d).padStart(2,"0")}
function nomeMes(m){return["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"][m]}

</script>
</body>
</html>
